<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>表数据查看和下载</title>

  <!-- 移除 Font Awesome 引用 -->
  <!-- 自定义基础样式（去除图标相关代码） -->
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f0f0;
    }

    header {
      background-color: #3b82f6;
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
    }

    nav a {
      color: white;
      text-decoration: none;
    }

    nav a:hover {
      color: #e0e0e0;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.2);
    }

    button {
      background-color: #3b82f6;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%; /* 调整按钮宽度为100% */
      max-width: 100px; /* 限制最大宽度 */
      margin: 0 auto; /* 居中显示 */
    }



    button:hover {
      background-color: #2563eb;
    }



    /* 修复按钮宽度被覆盖的问题 */
    #downloadBtn, #showTableBtn {
      width: auto !important;
      max-width: none;
    }


    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .error {
      color: red;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f5f5f5;
      text-align: left;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .loading {
      text-align: center;
      margin: 20px 0;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <main>
    <div class="max-w-5xl mx-auto">
      <div class="mb-8 text-center">
        <h2 class="font-bold text-dark mb-2">表数据查看和下载</h2>
      </div>

      <!-- 移除导航栏中的图标 -->
      <div class="nav-buttons">
        <a href="/" class="btn">登录</a>
        <a href="/upload" class="btn">上传</a>
        <a href="/delete_db" class="btn">删除数据库</a>
        <a href="/delete_tb" class="btn">删除表</a>
        <a href="/view_db" class="btn">查找数据库</a>
        <a href="/view_tb" class="btn">查找表</a> <!-- 移除 btn-danger 类 -->
      </div>
      <div style="height: 30px;"></div>

      <div class="form-container">
        <form id="showTableForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label for="db_name">数据库名</label>
              <!-- 移除图标相关的 HTML 结构 -->
              <input type="text" id="db_name" name="db_name" placeholder="输入数据库名">
            </div>

            <div class="form-group">
              <label for="tb_name">表名</label>
              <!-- 移除图标相关的 HTML 结构 -->
              <input type="text" id="tb_name" name="tb_name" placeholder="输入表名">
            </div>
          </div>

          <div class="pt-2">
            <!-- 移除按钮中的图标，调整文本居中 -->
            <button type="submit" id="showTableBtn">
              查看数据
            </button>

             <!-- 新增下载按钮 -->
            <button type="button" id="downloadBtn" class="w-auto bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
              下载CSV
            </button>

          </div>
        </form>
      </div>

      <div id="resultArea" class="result hidden">
        <div id="loadingIndicator" class="loading">
          <!-- 移除旋转图标，改用纯文本提示 -->
          <p class="mt-4">正在查询数据，请稍候...</p>
        </div>

        <div id="errorMessage" class="error hidden">
          <p id="errorText"></p>
        </div>

        <div id="tableResult" class="hidden">
          <h3 id="tableTitle" class="font-semibold mb-2"></h3>
          <div id="tableInfo" class="text-sm text-gray-600 mb-4"></div>
          <table>
            <thead>
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>

          </table>
          <p class="text-sm text-gray-600 mt-4">最多显示前 100 条记录, 导出上限为 10000 行。如需查看更多数据，请使用 SQL 查询功能。</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // JavaScript 部分无需修改（仅移除与图标相关的操作，此处代码与原版本一致）
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('showTableForm');
      const resultArea = document.getElementById('resultArea');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      const tableResult = document.getElementById('tableResult');
      const tableTitle = document.getElementById('tableTitle');
      const tableInfo = document.getElementById('tableInfo');
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      const showTableBtn = document.getElementById('showTableBtn');
      const downloadBtn = document.getElementById('downloadBtn'); // 获取下载按钮

      downloadBtn.addEventListener('click', async function() {
        const dbName = this.dataset.dbName;
        const tbName = this.dataset.tbName;

        if (!dbName || !tbName) {
          showError('请先查询数据');
          return;
        }

        // 显示加载状态
        loadingIndicator.classList.remove('hidden');
        downloadBtn.disabled = true;
        downloadBtn.textContent = '下载中...';

        try {
          const response = await fetch('/download_tb', {
            method: 'POST',
            body: new URLSearchParams({ db_name: dbName, tb_name: tbName })
          });

          if (!response.ok) {
            throw new Error('下载失败');
          }

          // 创建临时下载链接（处理浏览器兼容性）
          const blob = await response.blob();
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${dbName}_${tbName}_export.csv`;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

        } catch (error) {
          showError('下载数据失败，请重试');
        } finally {
          loadingIndicator.classList.add('hidden');
          downloadBtn.disabled = false;
          downloadBtn.textContent = '下载CSV';
       }
      });



      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const dbName = document.getElementById('db_name').value.trim();
        const tbName = document.getElementById('tb_name').value.trim();

        if (!dbName || !tbName) {
          showError('请输入数据库名和表名');
          return;
        }

        resultArea.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        tableResult.classList.add('hidden');

        showTableBtn.disabled = true;
        showTableBtn.textContent = '查询中...'; // 简化按钮文本

        try {
          const response = await fetch('/show_tb', {
            method: 'POST',
            body: new URLSearchParams({ db_name: dbName, tb_name: tbName })
          });
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }
           // **新增：激活下载按钮并绑定表名/库名**
          downloadBtn.disabled = false;
          downloadBtn.dataset.dbName = dbName;
          downloadBtn.dataset.tbName = tbName;



          renderTable(data, dbName, tbName);

        } catch (error) {
          // 重置下载按钮状态
          downloadBtn.disabled = true;
          showError(error.message);
        } finally {
          loadingIndicator.classList.add('hidden');
          showTableBtn.disabled = false;
          showTableBtn.textContent = '查看数据';
        }
      });



      function showError(message) {
        errorMessage.classList.remove('hidden');
        errorText.textContent = `错误: ${message || '获取数据失败'}`;
      }

      function renderTable(data, dbName, tbName) {
        tableTitle.textContent = `${dbName}.${tbName}`;
        tableInfo.textContent = `共 ${data.rows.length} 条记录（显示前100条）`;

        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        // **新增：在表头中添加序号列**
        const th = document.createElement('th');
        th.textContent = '序号';
        tableHeader.appendChild(th);

        // 渲染原有表头
        data.headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          tableHeader.appendChild(th);
        });

        const rowsToShow = data.rows.slice(0, 100);
        rowsToShow.forEach((row, index) => {
          const tr = document.createElement('tr');
          if (index % 2 === 0) {
            tr.classList.add('bg-gray-50'); // 保持原有斑马线效果
          }

          // **新增：在每行开头添加序号单元格**
          const serialTd = document.createElement('td');
          serialTd.textContent = index + 1; // 序号从1开始
          serialTd.style.textAlign = 'center'; // 序号居中显示
          tr.appendChild(serialTd);

          // 渲染原有数据单元格
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell === null || cell === undefined ? '-' : cell;
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });

        tableResult.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>