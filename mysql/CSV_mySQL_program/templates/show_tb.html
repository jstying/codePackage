<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>表数据查看和下载</title>

  <!-- 自定义基础样式 -->
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f0f0;
    }

    header {
      background-color: #3b82f6;
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
    }

    nav a {
      color: white;
      text-decoration: none;
    }

    nav a:hover {
      color: #e0e0e0;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.2);
    }

    button {
      background-color: #3b82f6;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      max-width: 100px;
      margin: 0 auto;
    }

    button:hover {
      background-color: #2563eb;
    }

    #downloadBtn,
    #showTableBtn {
      width: auto !important;
      max-width: none;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .error {
      color: red;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f5f5f5;
      text-align: left;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .loading {
      text-align: center;
      margin: 20px 0;
    }

    .hidden {
      display: none;
    }

    /* 分页按钮样式 - 类似百度风格 */
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 5px;
    }

    .pagination-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e1e4e8;
      background-color: #fff;
      color: #3b82f6;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 0;
      font-size: 14px;
    }

    /* 数字页码按钮 - 正方形 */
    .pagination-btn:not(.direction-btn) {
      min-width: 36px;
      height: 36px;
      padding: 0;
    }

    /* 方向按钮 - 长方形 */
    .pagination-btn.direction-btn {
      min-width: 60px;
      height: 36px;
      padding: 0 12px;
      font-size: 12px;
      /* 缩小字体 */
    }

    .pagination-btn:hover:not(.active) {
      border-color: #3b82f6;
      background-color: #f0f7ff;
    }

    .pagination-btn.active {
      background-color: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
      font-weight: bold;
    }

    .pagination-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-ellipsis {
      display: flex;
      align-items: center;
      padding: 0 8px;
      color: #666;
    }

  </style>
</head>

<body>

  <main>
    <div class="max-w-5xl mx-auto">
      <div class="mb-8 text-center">
        <h2 class="font-bold text-dark mb-2">表数据查看和下载</h2>
      </div>

      <div class="nav-buttons">
        <a href="/" class="btn">登录</a>
        <a href="/upload" class="btn">上传</a>
        <a href="/delete_db" class="btn">删除数据库</a>
        <a href="/delete_tb" class="btn">删除表</a>
        <a href="/view_db" class="btn">查找数据库</a>
        <a href="/view_tb" class="btn">查找表</a>
      </div>
      <div style="height: 30px;"></div>

      <div class="form-container">
        <form id="showTableForm" class="space-y-4">
          <input type="hidden" name="page" id="page" value="1">
          <input type="hidden" name="limit" value="10">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label for="db_name">数据库名</label>
              <input type="text" id="db_name" name="db_name" placeholder="输入数据库名">
            </div>

            <div class="form-group">
              <label for="tb_name">表名</label>
              <input type="text" id="tb_name" name="tb_name" placeholder="输入表名">
            </div>
          </div>

          <div class="form-group">
            <label for="search">搜索</label>
            <input type="text" id="search" name="search" placeholder="输入搜索关键字">
          </div>

          <div class="pt-2 flex justify-center gap-4">
            <button type="submit" id="showTableBtn">
              查看数据
            </button>

            <button type="button" id="downloadBtn" class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
              下载CSV
            </button>
          </div>
        </form>
      </div>

      <div id="resultArea" class="result hidden">
        <div id="loadingIndicator" class="loading">
          <p class="mt-4">正在查询数据，请稍候...</p>
        </div>

        <div id="errorMessage" class="error hidden">
          <p id="errorText"></p>
        </div>

        <div id="tableResult" class="hidden">
          <h3 id="tableTitle" class="font-semibold mb-2"></h3>
          <div id="tableInfo" class="text-sm text-gray-600 mb-4"></div>
          <table>
            <thead>
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>

          <!-- 分页容器 -->
          <div id="paginationContainer" class="pagination-container"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('showTableForm');
      const resultArea = document.getElementById('resultArea');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      const tableResult = document.getElementById('tableResult');
      const tableTitle = document.getElementById('tableTitle');
      const tableInfo = document.getElementById('tableInfo');
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      const showTableBtn = document.getElementById('showTableBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const searchInput = document.getElementById('search');

      // 分页变量
      let currentPage = 1;
      const itemsPerPage = 10;
      let totalPages = 1;
      let totalRows = 0;

      downloadBtn.addEventListener('click', async function () {
        const dbName = this.dataset.dbName;
        const tbName = this.dataset.tbName;

        if (!dbName || !tbName) {
          showError('请先查询数据');
          return;
        }

        loadingIndicator.classList.remove('hidden');
        downloadBtn.disabled = true;
        downloadBtn.textContent = '下载中...';

        try {
          const response = await fetch('/download_tb', {
            method: 'POST',
            body: new URLSearchParams({ db_name: dbName, tb_name: tbName })
          });

          if (!response.ok) {
            throw new Error('下载失败');
          }

          const blob = await response.blob();
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${dbName}_${tbName}_export.csv`;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

        } catch (error) {
          showError('下载数据失败，请重试');
        } finally {
          loadingIndicator.classList.add('hidden');
          downloadBtn.disabled = false;
          downloadBtn.textContent = '下载CSV';
        }
      });

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        currentPage = 1;
        fetchData();
      });

      searchInput.addEventListener('input', function () {
        currentPage = 1;
        fetchData();
      });

      function showError(message) {
        errorMessage.classList.remove('hidden');
        errorText.textContent = `错误: ${message || '获取数据失败'}`;
      }

      async function renderTable(data, dbName, tbName) {
        totalRows = data.total;
        totalPages = Math.ceil(totalRows / itemsPerPage);

        tableTitle.textContent = `${dbName}.${tbName}`;
        tableInfo.textContent = `共 ${totalRows} 条记录`;

        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        // 添加序号列
        const th = document.createElement('th');
        th.textContent = '序号';
        tableHeader.appendChild(th);

        // 渲染表头
        data.headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          tableHeader.appendChild(th);
        });

        // 渲染表格数据
        data.rows.forEach((row, index) => {
          const tr = document.createElement('tr');
          if (index % 2 === 0) {
            tr.classList.add('bg-gray-50');
          }

          // 添加序号单元格
          const serialTd = document.createElement('td');
          serialTd.textContent = index + 1 + (currentPage - 1) * itemsPerPage;
          serialTd.style.textAlign = 'center';
          tr.appendChild(serialTd);

          // 渲染数据单元格
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell === null || cell === undefined ? '-' : cell;
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });

        tableResult.classList.remove('hidden');
        renderPagination();
      }

      // 渲染分页按钮（类似百度风格）
      function renderPagination() {
        const container = document.getElementById('paginationContainer');
        container.innerHTML = '';

        // 添加上一页按钮
        const prevBtn = document.createElement('button');
        prevBtn.className = `pagination-btn direction-btn ${currentPage === 1 ? 'disabled' : ''}`;
        prevBtn.textContent = '上一页';
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            fetchData(currentPage);
          }
        });
        container.appendChild(prevBtn);

        let startPage = Math.max(1, currentPage - 5);
        let endPage = Math.min(totalPages, startPage + 9);

        if (endPage - startPage < 9 && startPage > 1) {
          startPage = Math.max(1, endPage - 9);
        }

        if (startPage > 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-ellipsis';
          ellipsis.textContent = '...';
          container.appendChild(ellipsis);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination-btn ${currentPage === i ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            fetchData(currentPage);
          });
          container.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-ellipsis';
          ellipsis.textContent = '...';
          container.appendChild(ellipsis);
        }

        // 添加下一页按钮
        const nextBtn = document.createElement('button');
        nextBtn.className = `pagination-btn direction-btn ${currentPage === totalPages ? 'disabled' : ''}`;
        nextBtn.textContent = '下一页';
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            currentPage++;
            fetchData(currentPage);
          }
        });
        container.appendChild(nextBtn);
      }

      // 获取数据（带分页和搜索）
      async function fetchData(page = 1) {
        const dbName = document.getElementById('db_name').value.trim();
        const tbName = document.getElementById('tb_name').value.trim();
        const search = document.getElementById('search').value.trim();

        if (!dbName || !tbName) {
          showError('请输入数据库名和表名');
          return;
        }

        resultArea.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        tableResult.classList.add('hidden');

        showTableBtn.disabled = true;
        showTableBtn.textContent = '查询中...';

        try {
          const response = await fetch('/show_tb', {
            method: 'POST',
            body: new URLSearchParams({
              db_name: dbName,
              tb_name: tbName,
              page: page,
              limit: itemsPerPage,
              search: search
            })
          });
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          downloadBtn.disabled = false;
          downloadBtn.dataset.dbName = dbName;
          downloadBtn.dataset.tbName = tbName;

          renderTable(data, dbName, tbName);

        } catch (error) {
          downloadBtn.disabled = true;
          showError(error.message);
        } finally {
          loadingIndicator.classList.add('hidden');
          showTableBtn.disabled = false;
          showTableBtn.textContent = '查看数据';
        }
      }
    });
  </script>
</body>

</html>